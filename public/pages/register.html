<!-- pages/register.html -->
<link rel="stylesheet" href="/css/style.css">
<script src="https://www.google.com/recaptcha/api.js" async defer></script>

<div class="language-selector">
  <select id="language">
    <option value="vi">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
  </select>
</div>

<div class="background"></div>

<div class="login-box">
  <h2>ÄÄƒng kÃ½ tÃ i khoáº£n âœ¨</h2>

  <form id="registerForm" autocomplete="off">
    <div class="input-group">
      <input type="text" id="newUsername" name="username" placeholder="TÃªn Ä‘Äƒng nháº­p" required />
    </div>

    <div class="input-group">
      <input type="email" id="email" name="email" placeholder="Email (@gmail.com)" required />
    </div>

    <div class="input-group">
      <input type="text" id="phone" name="phone" placeholder="Sá»‘ Ä‘iá»‡n thoáº¡i (10 sá»‘)" required pattern="0[0-9]{9}" />
    </div>

    <div class="input-group">
      <input type="password" id="newPassword" name="password" placeholder="Máº­t kháº©u" required />
      <span class="toggle-password" onclick="togglePassword('newPassword')"></span>
    </div>

    <div class="input-group">
      <input type="password" id="confirmPassword" placeholder="Nháº­p láº¡i máº­t kháº©u" required />
      <span class="toggle-password" onclick="togglePassword('confirmPassword')"></span>
    </div>

    <!-- Google reCAPTCHA (náº¿u báº¡n muá»‘n táº¯t khi dev thÃ¬ bá» <div> nÃ y) -->
    <div class="input-group">
      <div class="g-recaptcha" data-sitekey="6LeW6JIrAAAAAA00l7G0gTC1uT0b9BKuC2HcqAbA"></div>
    </div>

    <button id="submitBtn" type="submit">ÄÄƒng kÃ½</button>

    <div class="extra-links">
      <a href="login.html">ÄÃ£ cÃ³ tÃ i khoáº£n?</a>
    </div>
  </form>

  <p id="message" style="margin-top:10px;"></p>
</div>

<script>
  // Hiá»‡n/áº©n máº­t kháº©u
  function togglePassword(id) {
    const input = document.getElementById(id);
    if (!input) return;
    input.type = input.type === "password" ? "text" : "password";
  }

  const form = document.getElementById("registerForm");
  const msgEl = document.getElementById("message");
  const submitBtn = document.getElementById("submitBtn");

  // Helper hiá»ƒn thá»‹ thÃ´ng bÃ¡o
  function showMsg(text, color = "red") {
    msgEl.textContent = text;
    msgEl.style.color = color;
  }

  // HÃ m validate email (chá»‰ cho @gmail.com)
  function isGmail(email) {
    return typeof email === "string" && email.toLowerCase().endsWith("@gmail.com");
  }

  // Xá»­ lÃ½ submit
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    // Láº¥y giÃ¡ trá»‹
    const username = document.getElementById("newUsername").value.trim();
    const email = document.getElementById("email").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const password = document.getElementById("newPassword").value;
    const confirm = document.getElementById("confirmPassword").value;

    // Reset thÃ´ng bÃ¡o
    showMsg("");

    // Validate client-side
    if (!username) { showMsg("â— Vui lÃ²ng nháº­p tÃªn Ä‘Äƒng nháº­p"); return; }
    if (!isGmail(email)) { showMsg("â— Chá»‰ há»— trá»£ Ä‘á»‹a chá»‰ Gmail (@gmail.com)"); return; }
    if (!/^0\d{9}$/.test(phone)) { showMsg("â— Sá»‘ Ä‘iá»‡n thoáº¡i pháº£i gá»“m 10 chá»¯ sá»‘ vÃ  báº¯t Ä‘áº§u báº±ng 0"); return; }
    if (password.length < 6) { showMsg("ğŸ”’ Máº­t kháº©u pháº£i cÃ³ Ã­t nháº¥t 6 kÃ½ tá»±"); return; }
    if (password !== confirm) { showMsg("â— Máº­t kháº©u nháº­p láº¡i khÃ´ng khá»›p!"); return; }

    // Kiá»ƒm tra reCAPTCHA: náº¿u grecaptcha khÃ´ng tá»“n táº¡i (dev env) thÃ¬ cho phÃ©p tiáº¿p Ä‘á»ƒ test.
    let captchaResponse = "";
    if (window.grecaptcha && typeof grecaptcha.getResponse === "function") {
      captchaResponse = grecaptcha.getResponse();
      if (!captchaResponse) { showMsg("ğŸš« Vui lÃ²ng xÃ¡c minh báº¡n khÃ´ng pháº£i robot!"); return; }
    } else {
      // Grecaptcha chÆ°a load (vÃ­ dá»¥ dev), khÃ´ng block nhÆ°ng log Ä‘á»ƒ báº¡n biáº¿t
      console.warn("grecaptcha not found â€” continuing without captcha (dev mode).");
    }

    // Disable button Ä‘á»ƒ trÃ¡nh gá»­i nhiá»u láº§n
    submitBtn.disabled = true;
    const originalText = submitBtn.textContent;
    submitBtn.textContent = "Äang gá»­i...";

    try {
      const res = await fetch("/api/auth/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ username, email, phone, password, captcha: captchaResponse })
      });

      const data = await res.json();

      // Reset grecaptcha náº¿u cÃ³
      if (window.grecaptcha && typeof grecaptcha.reset === "function") {
        try { grecaptcha.reset(); } catch (err) { /* ignore */ }
      }

      if (res.ok) {
        showMsg("âœ… " + (data.message || "ÄÄƒng kÃ½ thÃ nh cÃ´ng!"), "green");

        // LÆ°u thÃ´ng tin user náº¿u backend tráº£ vá» user (giÃºp menu hiá»ƒn thá»‹)
        if (data.user) {
          try { localStorage.setItem("user", JSON.stringify(data.user)); } catch (e) { console.warn(e); }
        } else {
          // Náº¿u backend khÃ´ng tráº£ user, lÆ°u tá»‘i thiá»ƒu username/email
          try { localStorage.setItem("user", JSON.stringify({ username, email })); } catch (e) { /* ignore */ }
        }

        // Chuyá»ƒn sang trang login hoáº·c menu tuá»³ logic (á»Ÿ Ä‘Ã¢y sang menu)
        setTimeout(() => {
          if (typeof loadPage === "function") {
            loadPage("menu.html");
          } else {
            // fallback: má»Ÿ login page
            window.location.href = "/pages/login.html";
          }
        }, 900);
      } else {
        showMsg("âš ï¸ " + (data.message || "Lá»—i khi Ä‘Äƒng kÃ½"), "red");
      }
    } catch (err) {
      console.error(err);
      showMsg("ğŸš¨ Lá»—i mÃ¡y chá»§: " + (err.message || err));
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    }
  });
</script>
